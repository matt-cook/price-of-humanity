<html>
  <head>
    <script src="./js/lib/jquery.min.js"></script>
    <script src="./js/lib/jquery.transit.min.js"></script>
    <script src="./js/lib/jquery.csv.min.js"></script>
    <script src="./js/lib/jquery.ba-throttle-debounce.min.js"></script>
    <title>The Price of Humanity</title>
    <link rel="stylesheet" href="css/reset.css" type="text/css">
    <style type="text/css">
       body{
        color:#fff;
        font-family:helvetica,sans-serif;
       }
       a{
        color:#fff;
        text-decoration:none;
       }
       ul, li{
            margin:0;
           padding;0;
           list-style-type:none;
       }
       #interface{
        height:100%;
        width:100%;
        position:fixed;
       }
       #header{
        height:40px;
        width:100%;
        position:absolute;
        background:#000;
        text-align:center;
        text-transform:uppercase;
       }
       #header h1{
        height:40px;
        line-height:40px;
        float:left;
        font-weight:bold;
        margin:0 0 0 10px;
       }
       #cost{
        width:100px;
        position:absolute;
        top:40px;
        bottom:0px;
        left:0px;
        background:#000;
       }
       #location{
        width:150px;
        position:absolute;
        right:0px;
        top:40px;
        bottom:0px;
        background:#000;
       }
       #cost li{
        text-indent:-9999;
        display:block;
        height:1px;
        width:100%;
        background:#fff;
        margin:1px 0;
        opacity:0.5;
       }
       #location li{
        margin:1px 0;
        font-size:12px;
        background:#fff;
        opacity:0.5;
        text-align:left;
        padding:0px 4px 0px 10px;
        height:17px;
        line-height:17px;
        display:block;
       }
       #location li a{
        color:#000;
       }
       #content{
        height:100%;
        width:100%;
        position:absolute;
        bottom:0;
        right:0;
        left:0;
        top:0;
       }
       #content li{
        display:block;
        width:100%;
        height:100%;
        overflow:hidden;
        position:relative;
       }
       #content img, #content canvas{
        position:absolute;
        top:0;
        filter: saturate(20%);
        -webkit-filter: saturate(20%);
        -moz-filter: saturate(20%);
        -o-filter: saturate(20%);
        -ms-filter: saturate(20%);
        min-height:100%;
        height:auto;
        width:60%;
       }
       #content img{
        left:0;
       }
       #content canvas{
        right:0;
       }
       #content .info{
        display:block;
        position:absolute;
        bottom:40px;
        left:0;
        text-align:center;
        width:100%;
       }
       #content h2, #content h3{
        background:#000;
        padding:5px 10px;
        margin:0 0 15px 0;
        display:inline-block;
        font-weight:bold;
        max-width:80%;
        }
        #content h2{
            font-size:3em;
        }
        #content h3{
            font-size:1.5em;
        }
    </style>
  </head>
  <body>
  <div id="fb-root"></div>
    <script>    
window.fbAsyncInit = function() {
    //FB is ready
    FB.init({
      appId      : '428729383937921',
      status     : true,
      xfbml      : true
    });

$( document ).ready(function() {
    //FB and jQuery are ready
    
    var friends = [];
    var costs;
    var costImages;
    var dataLoaded = false;
    var friendsLoaded = false;
    var $window = $(window);
    
    $(window).scroll($.debounce(500, function(){
        var h = $window.height();
        $("html, body").animate({ scrollTop: (Math.round($window.scrollTop()/h)*h)+"px" });
    }));
    
    $.get('./data/cost.csv',function(data){
        costs = $.csv.toObjects(data);
        $.get('./data/cost-images.csv',function(data){
        
        costImages = $.csv.toObjects(data);
        dataLoaded = true;
        loadComplete();
        $.each(costs,function(i,c){
          var countryID = c.location.trim().toLowerCase().replace(' ','-');
          var costID = 'cost'+i;
          if(!$('#'+countryID).length){
            $('#location ul').append('<li id="'+countryID+'"><a href="#">'+c.location.trim()+'</a></li>');
          }
          $('#cost ul').append('<li id="'+costID+'" data-country="'+countryID+'"><a href="#">$'+c.cost.trim()+'</a></li>');
          var html = '<li data-cost="'+costID+'"><img src="http://placekitten.com/768/1026" alt="" /><canvas></canvas><div class="info"><h2><span class="name">Matt</span>&#39;s life is worth $'+c.cost+'</h2><br><h3>as '+c.as+' in '+c.location;
          if(c.when) html += ', '+c.when;
          html += '.</h3></div></li>';
          $c = $(html).appendTo($('#content ul'));
          var canvas = $c.find('canvas').get(0);
          var image = new Image();
          var ctx = canvas.getContext('2d');
          image.onload = function() {
            canvas.width = image.width;
            canvas.height = image.height;
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(image, 0, 0);
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(parseInt(0.27*canvas.width),0);
            ctx.lineTo(0,canvas.height);
            ctx.closePath();
            ctx.fill();
        };
        image.src = './img/cost/'+costImages[i].filename;
        });
        
        });
    });
    
    function loadComplete(){
        if(friendsLoaded && dataLoaded){
            //ready to go
            
            $.each(costs,function(i,c){
            	if(typeof c.gender === 'undefined' || c.gender.length == 0) c.gender = 'b';
            	for ( var j = 0; j < friends.length; j++){
            		if( typeof friends[j].gender != 'undefined' &&
            		    (c.gender == 'b' || c.gender == friends[j].gender[0]) && 
            		    !friends[j].used ){
            			
            			friends[j].used = true;
            			var content = $("#content li")[i];
            			$(content).find("img").attr("src", friends[j].photo);
            			$(content).find(".name").text(friends[j].name);
            			break;
            		}
            	}
            });
        }
    }
    
    $('a').click(function(e){
        FB.login(getFriends, {scope: 'basic_info,user_birthday,friends_birthday'});
    });
        
        function getFriends() {
            FB.api('/me/friends?fields=id,name,first_name,gender,birthday', function(a) {
                if(a.data) {
                    $.each(a.data,function(i,friend) {
                    
                        FB.api('/'+friend.id+'/picture?width=9999&height=9999',
                        function(b) {
                            if(!b.is_silhouette) {
                                friends[i] = {};
                                friends[i].name = friend.first_name;
                                friends[i].gender = friend.gender;
                                friends[i].photo = b.data.url;
                                friends[i].age = '';
                                friends[i].used = false;
                                if(friend.birthday){
                                    var c = friend.birthday.split('/');
                                    if(c.length == 3){
                                        friends[i].age =  new Date().getFullYear() - parseInt(c[2]);
                                    }
                                }
                            }
                            if(i == a.data.length-1){
                                friendsLoaded = true;
                                loadComplete();
                            }
                        });
                    });
                   
                } else {
                    alert("Error!");
                }
            });
        }

});

};

(function(d, s, id){
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) {return;}
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
    </script>
  </body>
    <div id="content"><ul></ul></div>
    <div id="interface">
        <div id="cost"><ul></ul></div>
        <div id="location"><ul></ul></div>
        <div id="header">
            <h1><a href="#">The Price of Humanity</a></h1>
        </div>
    </div>
  </html>